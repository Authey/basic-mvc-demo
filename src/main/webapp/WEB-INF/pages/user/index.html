<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User</title>
    <#include "*/resources.html" />
</head>
<body class="container-fluid">
    <table class="table">
        <tr><td><div>${type!}</div></td></tr>
        <tr><td><div id="user-alert"></div></td></tr>
    </table>
    <form class="form-horizontal">
        <div class="form-group">
            <label for="username" class="col-sm-2 control-label">Username:</label>
            <div class="col-sm-4">
                <input type="text" class="form-control" id="username" placeholder="username">
            </div>
        </div>
        <#if type != 'Manage'>
            <div class="form-group">
                <label for="password" class="col-sm-2 control-label">Password:</label>
                <div class="col-sm-4">
                    <input type="password" class="form-control" id="password" placeholder="password">
                </div>
            </div>
        </#if>
        <div class="form-group">
            <div class="col-sm-offset-2 col-sm-4">
                <#if type == 'Login'>
                    <input class="btn btn-primary" type="button" onclick="login()" value="Log In"/>
                <#elseif type == 'Enroll'>
                    <input class="btn btn-primary" type="button" onclick="enroll()" value="Enroll"/>
                <#elseif type == 'Manage'>
                    <input class="btn btn-info" type="button" onclick="load()" value="Load User"/>
                    <input class="btn btn-danger" type="button" onclick="remove()" value="Remove"/>
                </#if>
                <input class="btn btn-default" type="button" onclick="toHome()" value="Home"/>
            </div>
        </div>
    </form>
    <table id="user-info" class="table table-hover table-bordered"></table>
    <div id="user-pager"></div>
</body>
</html>

<script type="text/javascript">
    let $user_grid;

    if ("${type!}" === "Logout") {
        $.ajax({
            type: "POST",
            url: "${root!}/user/logout",
            async: false,
            data: {},
            dataType: "json",
            success: function(resp) {
                toHome()
            }
        })
    }

    function login() {
        let username = $("#username").val();
        let password = $("#password").val();
        $.ajax({
            type: "POST",
            url: "${root!}/user/login",
            async: false,
            data: {"username": username, "password": password},
            dataType: "json",
            success: function(resp) {
                let response = eval(resp)
                if (response.state === 1) {
                    toHome()
                } else {
                    $("#user-alert").html(warn(response.msg))
                }
            }
        })
    }

    function enroll() {
        let username = $("#username").val();
        let password = $("#password").val();
        $.ajax({
            type: "POST",
            url: "${root!}/user/enroll",
            async: false,
            data: {"username": username, "password": password},
            dataType: "json",
            success: function(resp) {
                let response = eval(resp)
                if (response.state === 1) {
                    window.location.href = "${root!}/user/index"
                } else {
                    $("#user-alert").html(warn(response.msg))
                }
            }
        })
    }

    function load() {
        $user_grid = jQuery("#user-info").jqGrid({
            url: "${root!}/user/load",
            datatype: "json",
            mtype: "POST",
            colNames: ['ID', 'USERNAME', 'PASSWORD', 'AUTH LEVEL'],
            colModel: [
                {name: 'ID', index: 'ID', hidden: true, align: 'center', width: 10},
                {name: 'USERNAME', index: 'USERNAME', hidden: false, align: 'center', width: 30},
                {name: 'PASSWORD', index: 'PASSWORD', hidden: false, align: 'center', width: 30},
                {name: 'AUTH_LEVEL', index: 'AUTH_LEVEL', hidden: false, align: 'center', width: 30}
            ],
            rowNum: 10,
            pager: "#user-pager",
            rownumbers: true,
            autoheight: true,
            autowidth: true,
            viewrecords: true
        })

        jQuery("#user-info").jqGrid('navGrid', "#user-pager", {
            add: false,
            edit: false,
            del : false,
            search : false,
            refresh : true
        })
    }

    function remove() {
        let username = $("#username").val();
        $.ajax({
            type: "POST",
            url: "${root!}/user/remove",
            async: false,
            data: {"username": username},
            dataType: "json",
            success: function(resp) {
                let response = eval(resp)
                if (response.state === 1 && response.msg !== "0") {
                    reload()
                } else if (response.msg === "0") {
                    $("#user-alert").html(warn("No Username Matched"))
                } else {
                    $("#user-alert").html(warn(response.msg))
                }
            }
        })
    }

    function toHome() {
        window.location.href = "${root!}/home"
    }

    function reload() {
        $("#user-alert").html('<div class="alert alert-success" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button><b>Delete User Successfully</b></div>')
        $user_grid.jqGrid('setGridParam', {
            search: true,
            postData: {},
            page: 1
        }).trigger("reloadGrid")
    }

    function warn(content) {
        return '<div class="alert alert-warning" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button><b>' + content + '</b></div>'
    }
</script>